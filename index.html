<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <title>Word Video</title>
    <style>
      :root {
        --bg: #0b1020;
        --panel: rgba(255, 255, 255, 0.06);
        --panel-2: rgba(255, 255, 255, 0.09);
        --stroke: rgba(255, 255, 255, 0.12);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.68);
        --shadow: 0 18px 60px rgba(0, 0, 0, 0.45);
        --radius: 16px;
        --radius-sm: 12px;
        --focus: 0 0 0 4px rgba(124, 92, 255, 0.35);
        --accent: #7c5cff;
        --ok: #19c37d;
        --bad: #ff4d4d;
      }

      @media (prefers-color-scheme: light) {
        :root {
          --bg: #f5f7ff;
          --panel: rgba(255, 255, 255, 0.88);
          --panel-2: rgba(255, 255, 255, 0.97);
          --stroke: rgba(0, 0, 0, 0.08);
          --text: rgba(15, 23, 42, 0.92);
          --muted: rgba(15, 23, 42, 0.62);
          --shadow: 0 18px 60px rgba(15, 23, 42, 0.12);
        }
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        font-family:
          ui-sans-serif,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Helvetica,
          Arial;
        color: var(--text);
        background:
          radial-gradient(1200px 700px at 15% -10%, rgba(124, 92, 255, 0.45), transparent 55%),
          radial-gradient(900px 600px at 90% 0%, rgba(25, 195, 125, 0.22), transparent 50%),
          radial-gradient(1000px 900px at 50% 110%, rgba(124, 92, 255, 0.18), transparent 60%),
          var(--bg);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .wrap {
        max-width: 900px;
        margin: 0 auto;
        padding: 18px 14px 28px;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 2px 18px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
      }

      .logo {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        background:
          radial-gradient(12px 12px at 30% 30%, rgba(255, 255, 255, 0.55), transparent 60%),
          linear-gradient(135deg, rgba(124, 92, 255, 1), rgba(25, 195, 125, 1));
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.25);
        border: 1px solid color-mix(in srgb, var(--stroke) 55%, transparent);
        flex: 0 0 auto;
      }

      .brand h1 {
        font-size: 14px;
        margin: 0;
        line-height: 1.2;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .brand p {
        margin: 2px 0 0;
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .card {
        border: 1px solid var(--stroke);
        background: var(--panel);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: clip;
      }

      .card-header {
        padding: 14px 14px 10px;
        border-bottom: 1px solid var(--stroke);
        background: color-mix(in srgb, var(--panel) 70%, transparent);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .card-header h2 {
        margin: 0;
        font-size: 16px;
        letter-spacing: -0.2px;
        min-width: 0;
      }

      .title-block {
        display: grid;
        gap: 2px;
        min-width: 0;
      }

      .phonetic {
        font-size: 13px;
        font-weight: 600;
        color: var(--muted);
        line-height: 1.2;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .card-body {
        padding: 14px;
        display: grid;
        gap: 12px;
      }

      .meta {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 7px 10px;
        border-radius: 999px;
        border: 1px solid var(--stroke);
        background: var(--panel-2);
        color: var(--muted);
        font-size: 12px;
      }

      .dot {
        width: 9px;
        height: 9px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--muted) 70%, transparent);
      }

      .dot.ok {
        background: var(--ok);
      }

      .dot.bad {
        background: var(--bad);
      }

      .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      .btn {
        appearance: none;
        border: 1px solid var(--stroke);
        border-radius: 12px;
        padding: 10px 12px;
        background: var(--panel-2);
        color: var(--text);
        font-weight: 700;
        font-size: 13px;
        cursor: pointer;
      }

      .btn.primary {
        border-color: color-mix(in srgb, var(--accent) 40%, var(--stroke));
        background: color-mix(in srgb, var(--accent) 22%, var(--panel-2));
      }

      .btn.small {
        padding: 9px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 750;
        white-space: nowrap;
      }

      .btn:focus-visible {
        outline: none;
        box-shadow: var(--focus);
      }

      .btn[disabled] {
        opacity: 0.55;
        cursor: not-allowed;
      }

      .field {
        display: grid;
        gap: 8px;
      }

      label {
        font-size: 12px;
        color: var(--muted);
      }

      input[type="text"],
      input[type="url"],
      textarea {
        width: 100%;
        padding: 12px 12px;
        border-radius: 12px;
        border: 1px solid var(--stroke);
        background: var(--panel-2);
        color: var(--text);
        font-size: 16px;
      }

      textarea {
        min-height: 96px;
        resize: vertical;
      }

      .hint {
        color: var(--muted);
        font-size: 12px;
        line-height: 1.45;
      }

      .feedback-panel {
        width: 100%;
        display: grid;
        gap: 10px;
        padding: 12px;
        border: 1px solid var(--stroke);
        border-radius: 12px;
        background: color-mix(in srgb, var(--panel-2) 65%, transparent);
      }

      .feedback-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      .video-frame {
        border: 1px solid var(--stroke);
        border-radius: var(--radius-sm);
        background: color-mix(in srgb, var(--panel-2) 65%, transparent);
        padding: 10px;
      }

      video {
        width: 100%;
        height: auto;
        border-radius: 12px;
        background: #000;
      }

      footer {
        padding: 14px 2px 0;
        color: var(--muted);
        font-size: 12px;
        text-align: center;
      }

      footer a {
        color: inherit;
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div style="min-width: 0">
            <h1>Word Video</h1>
            <p id="subtitle">Loading‚Ä¶</p>
          </div>
        </div>
      </header>

      <main class="card">
        <div class="card-header">
          <div class="title-block">
            <h2 id="title">Preparing‚Ä¶</h2>
            <div id="phonetic" class="phonetic" aria-live="polite"></div>
          </div>
          <button id="recent-btn" class="btn small" type="button">Recent generations</button>
        </div>
        <div class="card-body">
          <div class="meta">
            <span class="pill" aria-live="polite">
              <span id="status-dot" class="dot" aria-hidden="true"></span>
              <span id="status-text">Starting‚Ä¶</span>
            </span>
            <span class="pill">
              <span style="opacity: 0.85">Language</span>
              <span id="language-pill" style="font-weight: 800">English</span>
            </span>
          </div>

          <div class="video-frame" id="video-frame" hidden>
            <video id="video" controls playsinline preload="metadata"></video>
          </div>

          <div id="message" class="hint" aria-live="polite"></div>

          <div class="actions">
            <button id="refresh-btn" class="btn primary" type="button">Refresh</button>
            <button id="thumbs-up-btn" class="btn small" type="button" aria-label="Thumbs up vote">
              üëç
            </button>
            <button id="thumbs-down-btn" class="btn small" type="button" aria-label="Thumbs down vote">
              üëé
            </button>
            <button id="feedback-btn" class="btn small" type="button">Feedback</button>
            <div id="feedback-panel" class="feedback-panel" hidden>
              <div class="field">
                <label for="feedback-input">Your feedback</label>
                <textarea id="feedback-input" placeholder="Type feedback‚Ä¶"></textarea>
              </div>
              <div class="feedback-actions">
                <button id="feedback-submit-btn" class="btn primary small" type="button">Submit</button>
                <button id="feedback-cancel-btn" class="btn small" type="button">Cancel</button>
              </div>
            </div>
          </div>
        </div>
      </main>

      <footer>
        ¬© GoLingo App
        <a href="https://www.golingoapp.com/" target="_blank" rel="noopener noreferrer"
          >https://www.golingoapp.com/</a
        >
      </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script>
      const API_BASE = "https://ln686uub5b.execute-api.us-east-1.amazonaws.com/prod/video-generation";
      const VIDEO_PREFIX = "https://d1vly1vxrll6os.cloudfront.net/";
      const PHONETIC_API = "https://e86m6e34ra.execute-api.us-east-1.amazonaws.com/prod/";

      const EMAILJS_TEMPLATE_ID = "template_b5e3z3s";
      const EMAILJS_SERVICE_ID = "service_qog4aki";
      const EMAILJS_PUBLIC_KEY = "h76eERmw-nGkCVvMQ";

      const $ = (id) => document.getElementById(id);
      const phoneticCache = new Map();
      let latestPhoneticRequestId = 0;

      function initEmailJs() {
        try {
          if (!window.emailjs || typeof window.emailjs.init !== "function") return;
          try {
            window.emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });
          } catch {
            window.emailjs.init(EMAILJS_PUBLIC_KEY);
          }
        } catch {
          // Non-blocking: email is best-effort.
        }
      }

      function sendFeedbackEmail({ word, message }) {
        try {
          if (!window.emailjs || typeof window.emailjs.send !== "function") return Promise.resolve();
          try {
            return window.emailjs.send(
              EMAILJS_SERVICE_ID,
              EMAILJS_TEMPLATE_ID,
              { word, message },
              { publicKey: EMAILJS_PUBLIC_KEY },
            );
          } catch {
            return window.emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, { word, message });
          }
        } catch {
          return Promise.resolve();
        }
      }

      function normalizePrefix(prefix) {
        const value = (prefix || "").trim();
        if (!value) return "";
        return value.endsWith("/") ? value : value + "/";
      }

      function buildVideoUrl(s3Key) {
        if (!s3Key) return "";
        return normalizePrefix(VIDEO_PREFIX) + s3Key;
      }

      function setStatus(state, text) {
        const dot = $("status-dot");
        const label = $("status-text");
        label.textContent = text;
        dot.classList.remove("ok", "bad");
        if (state === "ok") dot.classList.add("ok");
        if (state === "bad") dot.classList.add("bad");
      }

      async function postJson(url, body) {
        const res = await fetch(url, {
          method: "POST",
          headers: {
            accept: "application/json",
            "Content-Type": "application/json",
          },
          body: body ? JSON.stringify(body) : "{}",
        });

        const text = await res.text();
        let json = null;
        try {
          json = text ? JSON.parse(text) : null;
        } catch {
          json = { raw: text };
        }

        if (!res.ok) {
          const message = (json && (json.message || json.error)) ? (json.message || json.error) : `HTTP ${res.status}`;
          const err = new Error(message);
          err.status = res.status;
          err.body = json;
          throw err;
        }
        return json;
      }

      function readParams() {
        const params = new URLSearchParams(location.search);

        const rawLanguage = (params.get("lang") || "").trim();
        const language = rawLanguage.toLowerCase() === "english" ? "English" : "English";

        const rawWord = (params.get("word") || "").trim();
        const word = rawWord || "apple";

        return { word, language };
      }

      function renderHeader({ word, language }) {
        $("language-pill").textContent = language;
        $("title").textContent = `‚Äú${word}‚Äù`;
        $("phonetic").textContent = "";
        $("subtitle").textContent = "Loads an existing video.";
      }

      function showVideo(url) {
        const video = $("video");
        video.src = url;
        $("video-frame").hidden = false;
      }

      function hideVideo() {
        const video = $("video");
        video.removeAttribute("src");
        video.load();
        $("video-frame").hidden = true;
      }

      function isUnsupportedLookupError(err) {
        const status = Number(err?.status || 0);
        return status === 404 || status === 405;
      }

      function extractVideoFromLookupResponse(data) {
        if (!data) return { found: false };

        // Expected response: an array of items. Empty array => not found.
        // Example item:
        // { word, language, s3_key, operation_id, created_at }
        if (Array.isArray(data)) {
          if (data.length === 0) return { found: false };
          const item = data[0] || null;
          const s3Key = item?.s3_key;
          const createdAt = item?.created_at ? String(item.created_at) : "";
          const operationId = item?.operation_id ? String(item.operation_id) : "";
          if (s3Key && typeof s3Key === "string") {
            return { found: true, videoUrl: buildVideoUrl(s3Key), createdAt, operationId };
          }
          return { found: true, createdAt, operationId };
        }

        // Fallback: tolerate object-shaped responses during rollout.
        const videoUrl = data?.video_url || data?.url || data?.video;
        if (videoUrl && typeof videoUrl === "string") return { found: true, videoUrl };

        const s3Key = data?.s3_key || data?.s3Key || data?.key || data?.item?.s3_key || data?.item?.s3Key;
        if (s3Key && typeof s3Key === "string") return { found: true, videoUrl: buildVideoUrl(s3Key) };

        const found = data?.found === true || data?.exists === true || data?.status === "ready";
        if (found) return { found: true };

        return { found: false };
      }

      async function lookupVideo({ word, language }) {
        const data = await postJson(`${API_BASE}/lookup`, { word, language });
        return extractVideoFromLookupResponse(data);
      }

      async function queueGeneration({ word, language }) {
        await postJson(`${API_BASE}/generate`, { word, language });
      }

      function extractPhoneticFromResponse(data) {
        const result = data?.body?.result ?? data?.result ?? data?.body?.phonetic ?? data?.phonetic;
        return typeof result === "string" ? result.trim() : "";
      }

      async function lookupPhonetic({ word, language }) {
        const key = `${language}::${word}`.toLowerCase();
        if (phoneticCache.has(key)) return phoneticCache.get(key) || "";

        const data = await postJson(PHONETIC_API, { word, lang: language });
        const result = extractPhoneticFromResponse(data);
        phoneticCache.set(key, result);
        return result;
      }

      async function loadPhonetic({ word, language }) {
        const requestId = ++latestPhoneticRequestId;
        const el = $("phonetic");
        el.setAttribute("aria-busy", "true");
        el.textContent = "‚Ä¶";
        try {
          const result = await lookupPhonetic({ word, language });
          if (requestId !== latestPhoneticRequestId) return;
          el.textContent = result || "";
        } catch {
          if (requestId !== latestPhoneticRequestId) return;
          el.textContent = "";
        } finally {
          if (requestId === latestPhoneticRequestId) el.removeAttribute("aria-busy");
        }
      }

      async function sendVote(vote) {
        const request = readParams();
        await postJson(`${API_BASE}/feedback`, { ...request, vote });
      }

      async function sendFeedback(feedback) {
        const request = readParams();
        await postJson(`${API_BASE}/feedback`, { ...request, feedback });
      }

      let generationQueuedForThisWord = false;

      async function loadOnce({ allowQueueGeneration }) {
        const request = readParams();
        renderHeader(request);
        loadPhonetic(request);
        hideVideo();

        setStatus("", "Checking library‚Ä¶");
        $("message").textContent = "";
        $("refresh-btn").disabled = true;

        try {
          const result = await lookupVideo(request);
          if (result.found && result.videoUrl) {
            showVideo(result.videoUrl);
            setStatus("ok", "Ready");
            const when = result.createdAt ? ` (${result.createdAt})` : "";
            $("message").textContent = `Found an existing video.${when}`;
            generationQueuedForThisWord = false;
            return;
          }

          if (result.found) {
            setStatus("ok", "Ready");
            const when = result.createdAt ? ` (${result.createdAt})` : "";
            $("message").textContent = `Found an existing video, but it is missing an s3_key.${when}`;
            generationQueuedForThisWord = false;
            return;
          }

          if (!allowQueueGeneration || generationQueuedForThisWord) {
            setStatus("", "Not ready yet");
            $("message").textContent = "Not available yet. Try again later.";
            return;
          }

          setStatus("", "Not found ‚Äî queuing‚Ä¶");
          $("message").textContent = "In generation ‚Äî coming later.";
          generationQueuedForThisWord = true;

          try {
            await queueGeneration(request);
            setStatus("", "Generating‚Ä¶");
          } catch (err) {
            generationQueuedForThisWord = false;
            $("message").textContent = "Could not start generation. Try again later.";
            setStatus("bad", "Error");
          }
        } catch (err) {
          if (isUnsupportedLookupError(err)) {
            if (!allowQueueGeneration || generationQueuedForThisWord) {
              setStatus("", "Not ready yet");
              $("message").textContent = "Try again later.";
              return;
            }

            setStatus("", "Queuing‚Ä¶");
            $("message").textContent = "In generation ‚Äî coming later.";
            generationQueuedForThisWord = true;

            try {
              await queueGeneration(request);
              setStatus("", "Generating‚Ä¶");
            } catch (err2) {
              generationQueuedForThisWord = false;
              $("message").textContent = "Could not start generation. Try again later.";
              setStatus("bad", "Error");
            }
            return;
          }

          $("message").textContent = "Something went wrong. Try again later.";
          setStatus("bad", "Error");
        } finally {
          $("refresh-btn").disabled = false;
        }
      }

      initEmailJs();

      $("refresh-btn").addEventListener("click", () => loadOnce({ allowQueueGeneration: false }));
      $("thumbs-up-btn").addEventListener("click", async () => {
        $("thumbs-up-btn").disabled = true;
        $("thumbs-down-btn").disabled = true;
        $("feedback-btn").disabled = true;
        const { word } = readParams();
        sendFeedbackEmail({ word, message: "User clicked thumbs up." }).catch(() => {});
        try {
          await sendVote(1);
          $("message").textContent = "Thanks for the vote!";
        } catch {
          $("message").textContent = "Could not submit vote. Try again later.";
        } finally {
          $("thumbs-up-btn").disabled = false;
          $("thumbs-down-btn").disabled = false;
          $("feedback-btn").disabled = false;
        }
      });

      $("thumbs-down-btn").addEventListener("click", async () => {
        $("thumbs-up-btn").disabled = true;
        $("thumbs-down-btn").disabled = true;
        $("feedback-btn").disabled = true;
        const { word } = readParams();
        sendFeedbackEmail({ word, message: "User clicked thumbs down." }).catch(() => {});
        try {
          await sendVote(-1);
          $("message").textContent = "Thanks for the vote!";
        } catch {
          $("message").textContent = "Could not submit vote. Try again later.";
        } finally {
          $("thumbs-up-btn").disabled = false;
          $("thumbs-down-btn").disabled = false;
          $("feedback-btn").disabled = false;
        }
      });

      $("feedback-btn").addEventListener("click", () => {
        const panel = $("feedback-panel");
        panel.hidden = !panel.hidden;
        if (!panel.hidden) $("feedback-input").focus();
      });

      $("feedback-cancel-btn").addEventListener("click", () => {
        $("feedback-panel").hidden = true;
        $("feedback-input").value = "";
      });

      $("feedback-submit-btn").addEventListener("click", async () => {
        const feedback = ($("feedback-input").value || "").trim();
        if (!feedback) {
          $("message").textContent = "Please enter feedback before submitting.";
          return;
        }

        $("feedback-submit-btn").disabled = true;
        $("feedback-cancel-btn").disabled = true;
        $("thumbs-up-btn").disabled = true;
        $("thumbs-down-btn").disabled = true;
        $("feedback-btn").disabled = true;
        const { word } = readParams();
        sendFeedbackEmail({ word, message: `User sent some feedback as: ${feedback}` }).catch(() => {});
        try {
          await sendFeedback(feedback);
          $("message").textContent = "Thanks for the feedback!";
          $("feedback-input").value = "";
          $("feedback-panel").hidden = true;
        } catch {
          $("message").textContent = "Could not submit feedback. Try again later.";
        } finally {
          $("feedback-submit-btn").disabled = false;
          $("feedback-cancel-btn").disabled = false;
          $("thumbs-up-btn").disabled = false;
          $("thumbs-down-btn").disabled = false;
          $("feedback-btn").disabled = false;
        }
      });
      $("recent-btn").addEventListener("click", () => {
        location.href = "recent.html";
      });

      // Initial load: check DB, then queue generation if missing.
      loadOnce({ allowQueueGeneration: true });
    </script>
  </body>
</html>
